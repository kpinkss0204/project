package com.example.myapplication.features.LocationSharing

import android.Manifest
import android.content.ClipData
import android.content.ClipboardManager
import android.content.Context
import android.content.pm.PackageManager
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.core.content.ContextCompat
import androidx.lifecycle.*
import com.example.myapplication.ui.components.KakaoMapViewCompose
import com.example.myapplication.services.LocationTrackingService
import com.google.firebase.database.*
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.Timestamp
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleEventObserver
import androidx.lifecycle.compose.LocalLifecycleOwner
import android.os.Build

@Composable
fun LocationSharingWithCodeScreen(
    onPartnerLocationChanged: (Pair<Double, Double>?) -> Unit = {}
) {
    val context = LocalContext.current
    val database = FirebaseDatabase.getInstance().reference.child("shared_locations")
    val firestore = FirebaseFirestore.getInstance()
    val sharedPreferences = remember {
        context.getSharedPreferences("location_sharing_prefs", Context.MODE_PRIVATE)
    }

    var partnerLocation by remember { mutableStateOf<Pair<Double, Double>?>(null) }
    var inputKey by remember { mutableStateOf("") }
    var generatedKey by remember {
        mutableStateOf(sharedPreferences.getString("generated_key", "") ?: "")
    }
    var hasLocationPermission by remember { mutableStateOf(false) }
    var hasNotificationPermission by remember { mutableStateOf(true) }
    var partnerKeyToWatch by remember { mutableStateOf<String?>(null) }
    var isBeingTracked by remember { mutableStateOf(false) }
    var isServiceRunning by remember { mutableStateOf(false) }

    // Í∂åÌïú ÏöîÏ≤≠ Îü∞Ï≤ò
    val locationPermissionLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        hasLocationPermission = permissions[Manifest.permission.ACCESS_FINE_LOCATION] == true ||
                permissions[Manifest.permission.ACCESS_COARSE_LOCATION] == true
    }

    val notificationPermissionLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { isGranted ->
        hasNotificationPermission = isGranted
    }

    val lifecycleOwner = LocalLifecycleOwner.current

    // Í∂åÌïú Ï≤¥ÌÅ¨
    LaunchedEffect(Unit) {
        hasLocationPermission = ContextCompat.checkSelfPermission(
            context,
            Manifest.permission.ACCESS_FINE_LOCATION
        ) == PackageManager.PERMISSION_GRANTED

        // Android 13 Ïù¥ÏÉÅÏóêÏÑúÎäî ÏïåÎ¶º Í∂åÌïú ÌïÑÏöî
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            hasNotificationPermission = ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.POST_NOTIFICATIONS
            ) == PackageManager.PERMISSION_GRANTED
        }
    }

    // ÏµúÏ¥à ÏïîÌò∏ ÏÉùÏÑ± Î∞è FirestoreÏóê Ï†ÄÏû•
    LaunchedEffect(Unit) {
        if (generatedKey.isEmpty()) {
            val chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#\$%^&*()-_=+"
            val newKey = (1..12).map { chars.random() }.joinToString("")
            generatedKey = newKey
            sharedPreferences.edit().putString("generated_key", newKey).apply()

            val messageDigest = java.security.MessageDigest.getInstance("SHA-256")
            val hashBytes = messageDigest.digest(newKey.toByteArray())
            val docId = hashBytes.joinToString("") { "%02x".format(it) }.take(32)

            val data = hashMapOf(
                "originalCode" to newKey,
                "docId" to docId,
                "createdAt" to Timestamp.now()
            )
            firestore.collection("location_keys")
                .document(docId)
                .set(data)
                .addOnSuccessListener {
                    android.util.Log.d("LocationSharing", "‚úÖ Ï†ÄÏû• ÏÑ±Í≥µ - ÏõêÎ≥∏: $newKey, Î¨∏ÏÑúID: $docId")
                }
                .addOnFailureListener { exception ->
                    android.util.Log.e("LocationSharing", "‚ùå Ï†ÄÏû• Ïã§Ìå®", exception)
                    Toast.makeText(context, "ÏïîÌò∏ÏΩîÎìú Ï†ÄÏû• Ïã§Ìå®: ${exception.message}", Toast.LENGTH_SHORT).show()
                }
        }
    }

    // ‚≠ê Firebase tracking_requests Í∞êÏãú - ÎàÑÍµ∞Í∞Ä ÎÇòÎ•º Ï∂îÏ†ÅÌïòÎ©¥ Foreground Service ÏãúÏûë
    DisposableEffect(generatedKey, hasLocationPermission, hasNotificationPermission) {
        if (generatedKey.isEmpty()) return@DisposableEffect onDispose {}

        val trackingRequestRef = FirebaseDatabase.getInstance()
            .reference.child("tracking_requests").child(generatedKey)

        val requestListener = object : ValueEventListener {
            override fun onDataChange(snapshot: DataSnapshot) {
                val wasTracked = isBeingTracked
                isBeingTracked = snapshot.exists()

                if (isBeingTracked && !wasTracked) {
                    android.util.Log.d("LocationSharing", "üîî ÎàÑÍµ∞Í∞Ä ÎÇòÎ•º Ï∂îÏ†ÅÌïòÍ∏∞ ÏãúÏûë!")

                    // Í∂åÌïú ÌôïÏù∏
                    if (!hasLocationPermission) {
                        Toast.makeText(context, "ÏúÑÏπò Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§", Toast.LENGTH_SHORT).show()
                        return
                    }

                    // Android 13+ ÏïåÎ¶º Í∂åÌïú ÌôïÏù∏
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU && !hasNotificationPermission) {
                        Toast.makeText(context, "ÏïåÎ¶º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§", Toast.LENGTH_SHORT).show()
                        return
                    }

                    // Foreground Service ÏãúÏûë
                    LocationTrackingService.startService(context, generatedKey)
                    isServiceRunning = true
                    Toast.makeText(context, "üîî Î∞±Í∑∏ÎùºÏö¥Îìú ÏúÑÏπò Í≥µÏú† ÏãúÏûë", Toast.LENGTH_SHORT).show()

                } else if (!isBeingTracked && wasTracked) {
                    android.util.Log.d("LocationSharing", "üîï Ï∂îÏ†Å Ï§ëÎã®Îê®")

                    // Foreground Service Ï§ëÎã®
                    LocationTrackingService.stopService(context)
                    isServiceRunning = false
                    Toast.makeText(context, "Ï∂îÏ†ÅÏù¥ Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§", Toast.LENGTH_SHORT).show()
                }
            }

            override fun onCancelled(error: DatabaseError) {
                isBeingTracked = false
                LocationTrackingService.stopService(context)
                isServiceRunning = false
            }
        }

        trackingRequestRef.addValueEventListener(requestListener)

        onDispose {
            trackingRequestRef.removeEventListener(requestListener)
        }
    }

    // ‚≠ê P2Í∞Ä P1Ïùò ÏúÑÏπòÎ•º Ïã§ÏãúÍ∞ÑÏúºÎ°ú Î∞õÍ∏∞
    DisposableEffect(partnerKeyToWatch) {
        val watchKey = partnerKeyToWatch
        if (watchKey.isNullOrEmpty()) return@DisposableEffect onDispose {}

        android.util.Log.d("LocationSharing", "üëÄ ÏÉÅÎåÄÎ∞© ÏúÑÏπò Í∞êÏãú ÏãúÏûë: $watchKey")

        val listener = object : ValueEventListener {
            override fun onDataChange(snapshot: DataSnapshot) {
                if (snapshot.exists()) {
                    val lat = snapshot.child("lat").getValue(Double::class.java)
                    val lon = snapshot.child("lon").getValue(Double::class.java)
                    if (lat != null && lon != null) {
                        partnerLocation = lat to lon
                        onPartnerLocationChanged(lat to lon)
                        android.util.Log.d("LocationSharing", "üìç ÏÉÅÎåÄÎ∞© ÏúÑÏπò ÏàòÏã†: $lat, $lon")
                    }
                } else {
                    android.util.Log.d("LocationSharing", "‚ö†Ô∏è ÏÉÅÎåÄÎ∞© ÏúÑÏπò Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå")
                }
            }

            override fun onCancelled(error: DatabaseError) {
                partnerLocation = null
                android.util.Log.e("LocationSharing", "‚ùå ÏÉÅÎåÄÎ∞© ÏúÑÏπò ÏàòÏã† Ïã§Ìå®", error.toException())
            }
        }

        database.child(watchKey).addValueEventListener(listener)

        onDispose {
            android.util.Log.d("LocationSharing", "üõë ÏÉÅÎåÄÎ∞© ÏúÑÏπò Í∞êÏãú Ï§ëÎã®: $watchKey")
            database.child(watchKey).removeEventListener(listener)
            partnerLocation = null
        }
    }

    // ‚≠ê Ïï± Î∞±Í∑∏ÎùºÏö¥Îìú/ÌôîÎ©¥ Ï†ÑÌôò/Îã§Î•∏ ÌéòÏù¥ÏßÄ Ïù¥Îèô Ïãú Ï∂îÏ†Å ÏûêÎèô Ï§ëÎã® (P2Í∞Ä P1ÏùÑ Ï∂îÏ†ÅÌïòÎäî Í≤ΩÏö∞)
    DisposableEffect(lifecycleOwner) {
        val observer = LifecycleEventObserver { _, event ->
            when (event) {
                Lifecycle.Event.ON_STOP, Lifecycle.Event.ON_PAUSE -> {
                    android.util.Log.d("LocationSharing", "üîÑ ÌôîÎ©¥ Ïù¥ÌÉà Í∞êÏßÄ - P2 Ï∂îÏ†Å Ï§ëÎã®")

                    // P2Í∞Ä P1ÏùÑ Ï∂îÏ†Å Ï§ëÏù¥ÏóàÎã§Î©¥ tracking_requests ÏÇ≠Ï†ú
                    partnerKeyToWatch?.let { watchKey ->
                        FirebaseDatabase.getInstance()
                            .reference.child("tracking_requests")
                            .child(watchKey)
                            .removeValue()
                            .addOnSuccessListener {
                                android.util.Log.d("LocationSharing", "‚úÖ tracking_requests ÏÇ≠Ï†ú ÏôÑÎ£å")
                            }
                    }

                    // P2 ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (P1Ïùò ÏÑúÎπÑÏä§Îäî Í≥ÑÏÜç Ïã§Ìñâ)
                    partnerKeyToWatch = null
                    partnerLocation = null
                    inputKey = ""
                }
                else -> {}
            }
        }

        lifecycleOwner.lifecycle.addObserver(observer)

        onDispose {
            lifecycleOwner.lifecycle.removeObserver(observer)

            // ÏôÑÏ†ÑÌûà Ï¢ÖÎ£åÎê† Îïå P2Ïùò Ï∂îÏ†Å Ï§ëÎã®
            partnerKeyToWatch?.let { watchKey ->
                FirebaseDatabase.getInstance()
                    .reference.child("tracking_requests")
                    .child(watchKey)
                    .removeValue()
            }
        }
    }

    // UI Íµ¨ÏÑ±
    LazyColumn(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        item {
            Text("üìç ÏúÑÏπò Í≥µÏú† (Î∞±Í∑∏ÎùºÏö¥Îìú Ï∂îÏ†Å)", style = MaterialTheme.typography.titleMedium)
        }

        // Í∂åÌïú ÏöîÏ≤≠ Ïπ¥Îìú
        if (!hasLocationPermission) {
            item {
                Card(colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.errorContainer)) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        Text(
                            "‚ö†Ô∏è ÏúÑÏπò Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.",
                            color = MaterialTheme.colorScheme.onErrorContainer,
                            style = MaterialTheme.typography.titleSmall
                        )
                        Spacer(modifier = Modifier.height(8.dp))
                        Button(
                            onClick = {
                                locationPermissionLauncher.launch(
                                    arrayOf(
                                        Manifest.permission.ACCESS_FINE_LOCATION,
                                        Manifest.permission.ACCESS_COARSE_LOCATION
                                    )
                                )
                            }
                        ) {
                            Text("ÏúÑÏπò Í∂åÌïú ÏöîÏ≤≠")
                        }
                    }
                }
            }
        }

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU && !hasNotificationPermission) {
            item {
                Card(colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.errorContainer)) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        Text(
                            "‚ö†Ô∏è ÏïåÎ¶º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§ (Î∞±Í∑∏ÎùºÏö¥Îìú Ï∂îÏ†ÅÏö©)",
                            color = MaterialTheme.colorScheme.onErrorContainer,
                            style = MaterialTheme.typography.titleSmall
                        )
                        Spacer(modifier = Modifier.height(8.dp))
                        Button(
                            onClick = {
                                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                                    notificationPermissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
                                }
                            }
                        ) {
                            Text("ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠")
                        }
                    }
                }
            }
        }

        // Î∞±Í∑∏ÎùºÏö¥Îìú Ï∂îÏ†Å ÏÉÅÌÉú ÌëúÏãú
        if (isBeingTracked && isServiceRunning) {
            item {
                Card(colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.primaryContainer)) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        Text(
                            "üîî Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÏúÑÏπò Í≥µÏú† Ï§ë",
                            color = MaterialTheme.colorScheme.onPrimaryContainer,
                            style = MaterialTheme.typography.titleSmall
                        )
                        Text(
                            "Ïï±ÏùÑ Ï¢ÖÎ£åÌï¥ÎèÑ ÏúÑÏπòÍ∞Ä Í≥ÑÏÜç Í≥µÏú†Îê©ÎãàÎã§",
                            color = MaterialTheme.colorScheme.onPrimaryContainer,
                            style = MaterialTheme.typography.bodySmall
                        )
                    }
                }
            }
        }

        item {
            Card {
                Column(modifier = Modifier.padding(16.dp)) {
                    Text("ÎÇ¥ Í≥†Ïú† ÏïîÌò∏ÏΩîÎìú", style = MaterialTheme.typography.titleSmall)
                    Spacer(modifier = Modifier.height(4.dp))
                    Text(
                        if (generatedKey.isNotEmpty()) generatedKey else "(ÏÉùÏÑ± Ï§ë...)",
                        style = MaterialTheme.typography.headlineMedium,
                        color = MaterialTheme.colorScheme.primary
                    )
                    Spacer(modifier = Modifier.height(8.dp))
                    Text(
                        "Ïù¥ ÏΩîÎìúÎ•º ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Í≥µÏú†ÌïòÏÑ∏Ïöî",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        }

        item {
            Button(
                onClick = {
                    if (generatedKey.isNotEmpty()) {
                        val clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
                        clipboard.setPrimaryClip(ClipData.newPlainText("ÏïîÌò∏ÏΩîÎìú", generatedKey))
                        Toast.makeText(context, "ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§", Toast.LENGTH_SHORT).show()
                    }
                },
                modifier = Modifier.fillMaxWidth(),
                enabled = generatedKey.isNotEmpty()
            ) {
                Text("üìã ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨")
            }
        }

        // ÏàòÎèôÏúºÎ°ú ÏÑúÎπÑÏä§ Ï§ëÎã® (ÌÖåÏä§Ìä∏Ïö©)
        if (isServiceRunning) {
            item {
                OutlinedButton(
                    onClick = {
                        LocationTrackingService.stopService(context)
                        isServiceRunning = false
                        Toast.makeText(context, "Î∞±Í∑∏ÎùºÏö¥Îìú Ï∂îÏ†ÅÏùÑ ÏàòÎèôÏúºÎ°ú Ï§ëÎã®ÌñàÏäµÎãàÎã§", Toast.LENGTH_SHORT).show()
                    },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = MaterialTheme.colorScheme.error
                    )
                ) {
                    Text("üõë Î∞±Í∑∏ÎùºÏö¥Îìú Ï∂îÏ†Å Ï§ëÎã® (ÏàòÎèô)")
                }
            }
        }

        item { HorizontalDivider() }

        item {
            Text("ÏÉÅÎåÄÎ∞© Ï∂îÏ†ÅÌïòÍ∏∞", style = MaterialTheme.typography.titleSmall)
        }

        item {
            OutlinedTextField(
                value = inputKey,
                onValueChange = { inputKey = it },
                label = { Text("ÏÉÅÎåÄÎ∞© ÏïîÌò∏ ÏûÖÎ†•") },
                modifier = Modifier.fillMaxWidth(),
                singleLine = true,
                enabled = partnerKeyToWatch == null
            )
        }

        item {
            Button(
                onClick = {
                    if (inputKey.isNotEmpty()) {
                        // tracking_requestsÏóê Ï∂îÏ†Å ÏöîÏ≤≠ Îì±Î°ù
                        val trackingRequestRef = FirebaseDatabase.getInstance()
                            .reference.child("tracking_requests").child(inputKey)

                        trackingRequestRef.setValue(true)
                            .addOnSuccessListener {
                                partnerKeyToWatch = inputKey
                                Toast.makeText(context, "‚úÖ Ï∂îÏ†Å ÏãúÏûë", Toast.LENGTH_SHORT).show()
                                android.util.Log.d("LocationSharing", "‚úÖ Ï∂îÏ†Å ÏãúÏûë: $inputKey")
                            }
                            .addOnFailureListener { e ->
                                Toast.makeText(context, "Ï∂îÏ†Å ÏãúÏûë Ïã§Ìå®: ${e.message}", Toast.LENGTH_SHORT).show()
                                android.util.Log.e("LocationSharing", "‚ùå Ï∂îÏ†Å ÏãúÏûë Ïã§Ìå®", e)
                            }
                    } else {
                        Toast.makeText(context, "ÏïîÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", Toast.LENGTH_SHORT).show()
                    }
                },
                modifier = Modifier.fillMaxWidth(),
                enabled = partnerKeyToWatch == null && inputKey.isNotEmpty()
            ) {
                Text("üîç ÏÉÅÎåÄÎ∞© ÏúÑÏπò Ï∂îÏ†Å ÏãúÏûë")
            }
        }

        if (partnerKeyToWatch != null) {
            item {
                OutlinedButton(
                    onClick = {
                        val watchKey = partnerKeyToWatch
                        if (watchKey != null) {
                            // tracking_requestsÏóêÏÑú ÏÇ≠Ï†ú
                            val trackingRequestRef = FirebaseDatabase.getInstance()
                                .reference.child("tracking_requests").child(watchKey)

                            trackingRequestRef.removeValue()
                                .addOnSuccessListener {
                                    partnerKeyToWatch = null
                                    partnerLocation = null
                                    inputKey = ""
                                    Toast.makeText(context, "Ï∂îÏ†ÅÏùÑ Ï§ëÎã®ÌñàÏäµÎãàÎã§.", Toast.LENGTH_SHORT).show()
                                    android.util.Log.d("LocationSharing", "üõë Ï∂îÏ†Å Ï§ëÎã®: $watchKey")
                                }
                        }
                    },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = MaterialTheme.colorScheme.error
                    )
                ) {
                    Text("‚èπÔ∏è Ï∂îÏ†Å Ï§ëÎã®")
                }
            }
        }

        // ÏÉÅÎåÄÎ∞© ÏúÑÏπò ÏßÄÎèÑ ÌëúÏãú
        if (partnerKeyToWatch != null) {
            item { HorizontalDivider() }
            item {
                Text(
                    "üë• ÏÉÅÎåÄÎ∞© ÏúÑÏπò Ï∂îÏ†Å Ï§ë",
                    style = MaterialTheme.typography.titleSmall
                )
            }

            if (partnerLocation != null) {
                item {
                    Text(
                        "ÏúÑÎèÑ: ${String.format("%.6f", partnerLocation!!.first)}, Í≤ΩÎèÑ: ${String.format("%.6f", partnerLocation!!.second)}",
                        style = MaterialTheme.typography.bodySmall
                    )
                }
                item {
                    KakaoMapViewCompose(
                        lat = partnerLocation!!.first,
                        lon = partnerLocation!!.second,
                        zoom = 15,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(300.dp)
                    )
                }
            } else {
                item {
                    Card(colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceVariant)) {
                        Text(
                            "‚è≥ ÏÉÅÎåÄÎ∞©Ïùò ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∏∞Îã§Î¶¨Îäî Ï§ë...",
                            modifier = Modifier.padding(16.dp),
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
        }
    }
}